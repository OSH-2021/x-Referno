## CEPH单机版部署

#### 环境说明

1台VMware虚拟机(ubuntu)

#### 安装CEPH部署工具（Ubuntu）

1. 添加release key

   ```shell
   wget -q -O- 'https://download.ceph.com/keys/release.asc' | sudo apt-key add -
   ```

2. 添加Ceph软件包源，用Ceph稳定版（如 `cuttlefish` 、 `dumpling` 、 `emperor` 、 `firefly` 等等）替换掉 `{ceph-stable-release}`. 如：

   ```shell
   echo deb http://download.ceph.com/debian-{ceph-stable-release}/ $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/ceph.list
   ```

3. 更新你的仓库，并安装 `ceph-deploy` :

   ```shell
   sudo apt-get update && sudo apt-get install ceph-deploy
   ```

#### 部署CEPH软件

```shell
mkdir myceph
cd myceph
ceph-deploy new {hostname}
```

若提示

```shell
UnableToResolveError: Unable to resolve host: {hostname}
```

则修改 /etc/hosts，添加相应的IP地址和hostname，然后重新deploy。

#### 设置集群副本数量

把如下内容加入到 ceph.conf 里面。

```shell
[global]
osd pool default size = 1
osd pool default  min size = 1 
```

#### 安装(luminous 版)

```shell
ceph-deploy install --release luminous {hostname} 
```

#### 初始化 mon

```
ceph-deploy mon create-initial
ceph-deploy admin {hostname}
```

#### 部署ceph mgr

```
ceph-deploy mgr create {hostname}
```

#### 部署osd

若无sdb，则在虚拟机里添加一个硬盘，然后

```shell
ceph-deploy osd create --data /dev/sdb {hostname}
```

部署完毕，可以通过以下命令查看系统状态

```shell
sudo chmod +r /etc/ceph/ceph.client.admin.keyring
ceph -s
```

![ceph_s](https://github.com/OSH-2021/x-seLVM/blob/main/pictures/ceph_s_1.png?raw=true)



## CEPH分布式部署

### 一、环境说明

3台VMware虚拟机：Ubuntu18.04(python版本为3.6.9，实测python版本3.8.10不支持platform.linux_distribution属性）

node1: admin node, monitor, mgr

node2: osd0

node3: osd1

### 二、准备工作

#### 在所有节点安装SSH服务器

```shell
sudo apt-get insatll openssh-server
```

####  修改hostname为node1, node2, node3

```shell
sudo vim /etc/hostname
```

#### 确保各节点主机名解析为网络IP地址而非回环接口地址（127.0.0.1）

```shell
ip address      #查看网络IP地址
sudo vim /etc/hosts		#添加一行: {hostname}  {IP address}
```

#### 配置管理主机node1, 使之可以通过SSH无密码访问各节点

```shell
ssh-keygen
ssh-copy-id node2
ssh-copy-id node3
```

####  管理主机上安装ceph-deploy

```shell
shudo apt-get install ceph-deploy
ceph-deploy --version	#查看ceph-deploy版本 e.g. 2.0.1
```

#### 在所有节点安装NTP并使用同一个NTP服务器, 避免时钟偏移

```shell
sudo apt-get install ntp
ntpstat		#查看ntp连接的服务器
```

### 三、CEPH部署

#### 在管理节点新建工作目录，后续操作在工作目录下完成

```shell
mkdir my-cluster
cd my-cluster
```

#### 创建monitor节点，生成一个ceph 配置文件、一个monitor密钥环和一个日志文件

```shell
ceph-deploy new node1		#node1作为monitor节点
```

#### 把ceph .conf里的默认副本数从3改成2, 把下面这行加入global段：

```shell
osd pool default size = 2
```

#### 安装ceph, --release {stable ceph version}设置希望安装的ceph版本

```shell
ceph-deploy install --release nautilus node1 node2 node3
```

#### 初始化monitor节点，生成monitor节点检测集群所需要的密钥文件

```shell
ceph-deploy mon create-initial
sudo chmod +r /etc/ceph/ceph.client.admin.keyring	#确保有读权限
ceph-deploy admin node1 node2 node3		#将生成的ceph.client.admin.keyring和配置文件push到各节点
```

#### 有monitor节点之后就可以查看集群状态

```shell
ceph -s
ceph health
```

#### 部署mgr节点

```shell
ceph-deploy mgr create node1
```

#### 部署osd节点

```shell
ceph-deploy osd create node2 --data /dev/sdb	#如果没有硬盘，需要新建
ceph-deploy osd create node3 --data /dev/sdb
```











